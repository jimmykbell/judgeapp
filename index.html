<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Judge Finder</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        input[type="file"], label {
            margin: 10px 0;
        }
        button {
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        select, input[type="text"] {
            padding: 5px;
            margin-bottom: 10px;
            margin-right: 10px;
            width: 200px;
        }
        tr:hover {
            background-color: #f1f1f1;
        }
        tr.selected {
            background-color: #d1ffd1 !important;
        }
    </style>
</head>
<body>

    <h2>Upload an Excel File to see competitors and judges</h2>

    <input type="file" id="excelFile" />
    <br>

    <label for="columnSelector">Select Columns to Toggle Visibility:</label><br>
    <select id="columnSelector" multiple>
        <option value="">-- Select Columns --</option>
    </select>
    <br>
    <button onclick="toggleColumnVisibility()">Toggle Visibility</button>
    <br>

    <!-- Filters -->
    <label for="searchInput">Search (Name or Division):</label>
    <input type="text" id="searchInput" onkeyup="applyFilters()" placeholder="Search...">

    <select id="ageFilter" onchange="applyFilters()">
        <option value="">All Ages</option>
        <option value="under15">Under 15</option>
        <option value="15to17">15-17</option>
        <option value="18plus">18+</option>
    </select>

    <select id="rankFilter" onchange="applyFilters()">
        <option value="">All Ranks</option>
    </select>

    <select id="divisionFilter" onchange="applyFilters()">
        <option value="">All Divisions</option>
    </select>

    <button onclick="resetFilters()">Reset</button>
    <button onclick="exportCSV()">Export CSV</button>

    <table id="dataTable">
        <thead>
            <tr></tr>
        </thead>
        <tbody></tbody>
    </table>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script>
        let sheetData = [];
        let filteredData = [];
        let columnNames = [];

        document.getElementById('excelFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    const data = event.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    sheetData = XLSX.utils.sheet_to_json(sheet);
                    columnNames = Object.keys(sheetData[0]);
                    generateColumnSelector();
                    generateDynamicFilters();
                    applyFilters();
                };
                reader.readAsBinaryString(file);
            }
        });

        function displayData(data) {
            const tableBody = document.querySelector('#dataTable tbody');
            const tableHeader = document.querySelector('#dataTable thead tr');
            tableBody.innerHTML = '';
            tableHeader.innerHTML = '';

            columnNames.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                tableHeader.appendChild(th);
            });

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.title = `Name: ${row['Name'] || ''}\nAge: ${row['Competition Age'] || ''}\nRank: ${row['Rank Group'] || ''}`;
                tr.onclick = () => tr.classList.toggle('selected');
                columnNames.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header];
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }

        function generateColumnSelector() {
            const selector = document.getElementById('columnSelector');
            selector.innerHTML = '';
            columnNames.forEach((col, i) => {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = col;
                selector.appendChild(option);
            });
        }

        function toggleColumnVisibility() {
        return !isNaN(age) && age >= ageLimit && ranks.includes(rank);
      }).sort((a, b) => {
        const ageA = parseInt(a['Competition Age'], 10);
        const ageB = parseInt(b['Competition Age'], 10);
        const rankA = ranks.indexOf(a['Rank Group']);
        const rankB = ranks.indexOf(b['Rank Group']);
        return ageA - ageB || rankA - rankB;
      });
      displayData(displayedData);
    }

    function resetTable() {
      displayedData = [...sheetData];
      displayData(displayedData);
      document.getElementById('searchInput').value = '';
    }

    function searchTable() {
      const input = document.getElementById('searchInput').value.toLowerCase();
      displayedData = sheetData.filter(row => {
        return (row['Name'] && row['Name'].toLowerCase().includes(input)) ||
               (row['Division'] && row['Division'].toLowerCase().includes(input));
      });
      displayData(displayedData);
    }

    function exportToCSV() {
      const rows = [['"' + columnNames.join('","') + '"']];
      displayedData.forEach(row => {
        const values = columnNames.map(key => '"' + (row[key] || '') + '"');
        rows.push(values);
      });
      const csv = rows.map(e => e.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'judges_filtered.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  </script>
</body>
</html>
